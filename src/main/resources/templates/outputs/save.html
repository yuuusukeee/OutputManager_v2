<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
  <meta charset="UTF-8">
  <title th:text="*{id} != null ? 'アウトプット編集' : 'アウトプット登録'">アウトプット登録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <style>
    .form-shell{max-width:720px;margin:24px auto;}
    .row{display:grid;grid-template-columns:1fr 280px;gap:16px}
    @media(max-width:768px){.row{grid-template-columns:1fr}}
    .preview{border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;background:#fafafa;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center}
    .preview img{width:100%;height:100%;object-fit:cover}
    .note{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
  <div th:replace="~{fragments/header :: body}"></div>

  <main class="form-shell">
    <a th:href="@{/outputs}" class="btn btn-outline">← 一覧へ戻る</a>
    <h1 class="page-title" th:text="*{id} != null ? 'アウトプット編集' : 'アウトプット登録'">アウトプット登録</h1>

    <!-- action は現在のURL（/outputs/save or /outputs/{id}/update でもOK）。ここでは /outputs/save に統一 -->
    <form th:action="@{/outputs/save}" method="post" th:object="${outputForm}" enctype="multipart/form-data">
      <input type="hidden" th:if="*{id != null}" th:field="*{id}">
      <input type="hidden" th:field="*{existingIcon}">

      <div class="field">
        <label>アウトプットタイトル</label>
        <input type="text" th:field="*{title}" maxlength="50" required>
        <small class="error" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">error</small>
      </div>

      <div class="field">
        <label>アウトプット概要</label>
        <textarea th:field="*{summary}" maxlength="500" rows="2"></textarea>
        <small class="error" th:if="${#fields.hasErrors('summary')}" th:errors="*{summary}">error</small>
      </div>

      <div class="field">
        <label>アウトプット詳細</label>
        <textarea th:field="*{detail}" maxlength="2000" rows="6" placeholder="プレーンテキスト（改行のみ反映）"></textarea>
        <small class="error" th:if="${#fields.hasErrors('detail')}" th:errors="*{detail}">error</small>
      </div>

      <div class="field">
        <label>アウトプット種別（カテゴリ）</label>
        <select th:field="*{categoryId}" required>
          <option value="">選択してください</option>
          <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
        </select>
        <small class="error" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}">error</small>
      </div>

      <div class="row">
        <div>
          <div class="field">
            <label>画像（任意／ファイルアップロード）</label>
            <input type="file" th:field="*{imageFile}" accept=".jpg,.jpeg,.png,.webp" onchange="previewFile(this)">
            <div class="note">※ 画像と動画は同時に登録できません</div>
            <small class="error" th:if="${#fields.hasErrors('imageFile')}" th:errors="*{imageFile}">error</small>
          </div>

          <div class="field">
            <label>動画URL（任意／YouTubeのみ）</label>
            <input type="url" th:field="*{videoUrl}" placeholder="https://www.youtube.com/watch?v=...">
            <div class="note">※ 画像と動画は同時に登録できません</div>
            <small class="error" th:if="${#fields.hasErrors('videoUrl')}" th:errors="*{videoUrl}">error</small>
          </div>
        </div>

        <div>
          <div class="preview">
            <img id="iconPreview"
                 th:src="${#strings.isEmpty(outputForm?.existingIcon) ? '/img/placeholder.png' : outputForm.existingIcon}"
                 alt="preview"
                 th:attr="onerror=|this.onerror=null;this.src='@{/img/placeholder.png}'|">
          </div>
          <div class="note" style="margin-top:6px;">プレビューは画像のみ表示します（動画はサムネ表示しません）。</div>
        </div>
      </div>

      <div th:if="${#fields.hasGlobalErrors()}" class="alert danger" th:text="${#fields.globalErrors()[0].defaultMessage}"></div>

      <button class="btn-primary" type="submit" th:text="*{id} != null ? '更新する' : '保存する'">保存する</button>
      <a class="btn" th:href="@{/outputs}">キャンセル</a>
    </form>
  </main>

  <script>
    function previewFile(input){
      const img = document.getElementById('iconPreview');
      if(!input.files || input.files.length===0){ img.src = '[[${"/img/placeholder.png"}]]'; return; }
      const file = input.files[0];
      const ok = ['image/jpeg','image/png','image/webp'];
      if(!ok.includes(file.type)){ img.src = '[[${"/img/placeholder.png"}]]'; return; }
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
