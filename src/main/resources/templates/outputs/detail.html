<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${output.title}">Output Detail</title>
  <link rel="stylesheet" th:href="@{/css/app.css}"/>
  <style>
    .wrap{max-width:1120px;margin:24px auto;display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
    @media(max-width:768px){.wrap{grid-template-columns:1fr}}
    .media{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fafafa}
    .ratio{position:relative;width:100%;aspect-ratio:16/9}
    .ratio img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .play { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;}
    .play::before{content:""; width:56px; height:56px; border-radius:999px; background:rgba(0,0,0,.45); display:inline-block;}
    .play::after{content:""; margin-left:-38px; border-left:20px solid #fff; border-top:12px solid transparent; border-bottom:12px solid transparent;}
    @media(max-width:480px){.play::before{width:44px;height:44px}.play::after{margin-left:-30px;border-left-width:16px;border-top-width:10px;border-bottom-width:10px}}
    .meta .row{display:flex;gap:12px;align-items:center;margin:4px 0}
    .label{color:#6b7280}
    .fav{margin:10px 0}
    .btn-star{background:none;border:none;cursor:pointer;font-size:20px;line-height:1}
    .body h3{margin-top:18px}
    .preline{white-space:pre-line}
  </style>
</head>
<body>
  <div th:replace="~{fragments/header :: body}"></div>

  <main class="wrap">
    <section>
      <h1 class="page-title" th:text="${output.title}">タイトル</h1>
      <div class="media">
        <div class="ratio">
          <img id="mainThumb"
               th:alt="${output.title}"
               th:attr="data-icon=${output.icon},data-vurl=${output.videoUrl}"
               th:src="@{/img/placeholder.png}"
               onerror="this.onerror=null;this.src='[[${'/img/placeholder.png;'}]]'">
          <a th:if="${output.videoUrl != null and !#strings.isEmpty(output.videoUrl)}"
             class="play"
             th:href="${output.videoUrl}"
             target="_blank" rel="noopener"
             role="link" tabindex="0" aria-label="動画を新しいタブで開く">
          </a>
        </div>
      </div>

      <div class="body">
        <h3>概要</h3>
        <p class="preline" th:text="${output.summary}">概要</p>

        <h3>詳細</h3>
        <div class="preline" th:text="${output.detail}">詳細</div>
      </div>
    </section>

    <aside class="meta">
      <div class="row"><span class="label">ジャンル：</span><span th:text="${categoryLabel}">学習</span></div>
      <div class="row"><span class="label">登録者：</span><span th:text="${session.loginUserName}">me</span></div>
      <div class="row"><span class="label">登録日：</span><span th:text="${#temporals.format(output.createdAt,'yyyy/MM/dd')}">2025/01/01</span></div>
      <div class="row" th:if="${output.updatedAt != null}">
        <span class="label">更新日：</span><span th:text="${#temporals.format(output.updatedAt,'yyyy/MM/dd')}">2025/01/02</span>
      </div>

      <div class="fav">
        <!-- ☆トグル：状態が分かる場合のみ表示（なければ後日実装時にDOM追加） -->
        <form th:action="@{/favorites/add}" method="post" th:if="${favored == null or !favored}">
          <input type="hidden" name="outputId" th:value="${output.id}">
          <button type="submit" class="btn-star" aria-label="お気に入りに追加">☆ 追加</button>
        </form>
        <form th:action="@{/favorites/remove}" method="post" th:if="${favored != null and favored}">
          <input type="hidden" name="outputId" th:value="${output.id}">
          <button type="submit" class="btn-star" aria-label="お気に入りを解除">★ 解除</button>
        </form>
      </div>

      <div class="row" style="gap:8px;margin-top:12px;">
        <a th:href="@{/outputs/edit/{id}(id=${output.id})}" class="btn btn-outline">編集</a>
        <form th:action="@{/outputs/delete}" method="post" onsubmit="return confirm('このアウトプットを削除します。よろしいですか？');">
          <input type="hidden" name="id" th:value="${output.id}">
          <button type="submit" class="btn btn-outline danger">削除</button>
        </form>
      </div>
    </aside>
  </main>

  <script>
    function ytId(url){
      if(!url) return null;
      try{
        const u = new URL(url);
        const h = u.hostname.replace('www.','');
        if(h==='youtu.be'){ return u.pathname.slice(1); }
        if(h==='youtube.com' || h==='m.youtube.com'){
          if(u.pathname.startsWith('/watch')) return u.searchParams.get('v');
          if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2];
          if(u.pathname.startsWith('/embed/')) return u.pathname.split('/')[2];
        }
      }catch(_){}
      return null;
    }
    const img = document.getElementById('mainThumb');
    const icon = img?.getAttribute('data-icon') || '';
    const vurl = img?.getAttribute('data-vurl') || '';
    if(icon.trim()){ img.src = icon; }
    else{
      const id = ytId(vurl);
      if(id){ img.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`; }
    }
  </script>
</body>
</html>